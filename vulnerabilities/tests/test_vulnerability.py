import pytest
from rest_framework.test import APITestCase
from rest_framework import status
from django.contrib.auth.models import User
from ..models import Vulnerability, FixedVulnerability


@pytest.mark.django_db
class VulnerabilityAPITestCase(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass')
        self.client.force_authenticate(user=self.user)

        self.vuln1 = Vulnerability.objects.create(cve_id="CVE-2024-0001", severity="High", description="Test vulnerability 1")
        self.vuln2 = Vulnerability.objects.create(cve_id="CVE-2024-0002", severity="Low", description="Test vulnerability 2")
        self.fixed_vuln = FixedVulnerability.objects.create(vulnerability=self.vuln1, fixed_by=self.user)

    def test_list_vulnerabilities(self):
        response = self.client.get('/api/vulnerabilities/')
        assert response.status_code == status.HTTP_200_OK
        assert isinstance(response.data, list)
        assert len(response.data) == 2

    def test_list_fixed_vulnerabilities(self):
        response = self.client.get('/api/fixed/')
        assert response.status_code == status.HTTP_200_OK
        assert isinstance(response.data, list)
        assert len(response.data) == 1

    def test_list_unfixed_vulnerabilities(self):
        response = self.client.get('/api/vulnerabilities-unfixed/')
        assert response.status_code == status.HTTP_200_OK
        assert isinstance(response.data, list)
        assert len(response.data) == 1

    def test_list_vulnerability_summary(self):
        response = self.client.get('/api/vulnerabilities-summary/')
        assert response.status_code == status.HTTP_200_OK
        assert isinstance(response.data, list)

    def test_delete_vulnerability(self):
        response = self.client.delete(f'/api/vulnerabilities/delete/{self.vuln1.cve_id}/')
        assert response.status_code == status.HTTP_204_NO_CONTENT
        assert not Vulnerability.objects.filter(cve_id=self.vuln1.cve_id).exists()

    def test_unfixed_vulnerabilities_empty(self):
        Vulnerability.objects.all().delete()
        response = self.client.get('/api/vulnerabilities-unfixed/')
        assert response.status_code == status.HTTP_200_OK
        assert response.data == {"message": "No hay vulnerabilidades sin resolver"}

    def test_vulnerability_summary_empty(self):
        Vulnerability.objects.all().delete()
        response = self.client.get('/api/vulnerabilities-summary/')
        assert response.status_code == status.HTTP_200_OK
        assert response.data == {"message": "No hay registros disponibles"}
